"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.addWebClientRoutes = void 0;
function addWebClientRoutes(app, details, proxy, unknownProxy) {
    const appTarget = `http://127.0.0.1:${details.httpPort}/app/`;
    app.use('/app', (req, res) => {
        const target = details.target;
        if (req.url === '/' && target.homepage.includes('/__catalyst')) {
            req.url = target.homepage;
            unknownProxy(req, res);
        }
        else if (req.url.startsWith('/local-redirect') && target.login_redirect) {
            const isUrl = target.login_redirect.startsWith('/');
            if (isUrl) {
                res.redirect(target.login_redirect);
            }
            else {
                res.redirect('/app/' + target.login_redirect);
            }
        }
        else {
            proxy.web(req, res, {
                target: appTarget,
                changeOrigin: true
            });
        }
    });
    const appTargetUrl = new URL(appTarget);
    appTargetUrl.pathname = '';
    appTargetUrl.protocol = 'ws';
    app.addListener('upgrade', (...upgradeParam) => {
        proxy.ws(upgradeParam[0], upgradeParam[1], upgradeParam[2], {
            target: appTargetUrl.href,
            ws: true,
            changeOrigin: true
        });
    });
}
exports.addWebClientRoutes = addWebClientRoutes;
